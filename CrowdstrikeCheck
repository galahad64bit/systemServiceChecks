package crowdstrike

import (
	"context"
	"errors"
	"fmt"
	"io/fs"
	"os"
	"os/exec"
	"strings"

	"google3/third_party/golang/stringset/stringset"
)

var (
	pkgName       = "falcon-sensor"
	processPath   = "/opt/CrowdStrike/falconctl"

	// Server CID: CA7F54901CDA488496503085C99B2F3D-A6
	// Client CID: F3C9100733704C2999046FEDA48410B7-2D

	// cidServer     = "ca7f54901cda488496503085c99b2f3d"
	cidClient = "f3c9100733704c2999046feda48410b7"
)

func main(){
}

func checkCrowdStrike(ctx context.Context) (string, error) {
	fmt.Println("Checking if crowdstrike package is installed")

	installed, err := isCrowdStrikeInstalled(ctx)
	if err != nil {
		return "", fmt.Error("Failed to check if CrowdStrike is installed")
	}
	if !installed {
		return "install", fmt.Error("CrowdStrike package is not installed")
	}

	// Check if processPath exists, bash way: if [ -f /opt/CrowdStrike/falconctl ]; then echo "exist";fi
	_, err = os.Stat(processPath)
	if errors.Is(err, fs.ErrNotExist) {
		log.ErrorContextf(ctx, "Failed to stat %s: %v", processPath, err)
		return "reinstall" , fmt.Errorf("Failed to stat %s", processPath)
	}

	fmt.Println("Checking if crowdstrike service is running")

	if err := cmd.Run(ctx, "systemctl", cmd.WithArgs("status", "falcon-sensor")); err != nil {
		if exitError, ok := err.(*exec.ExitError); ok {
			switch exitError.ExitCode() {
			case 0:
				return fmt.Println("CrowdStrike service is running"), nil
			case 3:
				return "unmask", fmt.Error("CrowdStrike service is masked, will try to unmask")
			case 4:
				return "install", fmt.Error("Failed to run systemctl status falcon-sensor, trying to install") // checkCrowdStrikePackage should install the package, but if it fails, we can try to install it again here
			default:
				return "restart", fmt.Error("Failed to run systemctl status falcon-sensor, trying to restart")
			}
		}
	}
	return fmt.Println("CrowdStrike service seems to be in a healthy state"), nil
}

func isCrowdStrikeInstalled(ctx context.Context) (bool, error) {
	if output, err := cmd.Output(ctx, "/usr/bin/apt", cmd.WithArgs("list", "--installed")); err != nil {
		return false, fmt.Errorf("Failed to run apt --installed list: %v", err)
	} else if !strings.Contains(string(output), pkgName) {
		return false, nil
	}
	return true, nil
}

// TODO: heistant on doing a install and reinstall of crowdstrike. Tabane should be able to do this.
func installCrowdStrike(ctx context.Context) (string,error) {
	fmt.Println("Installing CrowdStrike")
	// install falcon-sensor
	if err := cmd.Run(ctx, "/usr/bin/apt-get", cmd.WithArgs("install", pkgName)); err != nil {
		return fmt.Errorf("Unable to install %s", pkgName)
	}
	// sudo /opt/CrowdStrike/falconctl -s --cid="F3C9100733704C2999046FEDA48410B7-2D"
	if err := cmd.Run(ctx, processPath, cmd.WithArgs("-s"), cmd.WithArgs("--cid=F3C9100733704C2999046FEDA48410B7-2D")); err != nil {
		return fmt.Error("Unable to run falconctl")
	}
	return "restart", nil
}

func reinstallCrowdStrike(ctx context.Context) (string, error) {
	fmt.Println("Reinstalling CrowdStrike")
	// reinstall falcon-sensor
	if err := cmd.Run(ctx, "/usr/bin/apt-get", cmd.WithArgs("install", "--reinstall", pkgName)); err != nil {
		return fmt.Errorf("Unable to reinstall %s", pkgName)
	}
	// sudo /opt/CrowdStrike/falconctl -s --cid="F3C9100733704C2999046FEDA48410B7-2D"
	if err := cmd.Run(ctx, processPath, cmd.WithArgs("-s"), cmd.WithArgs("--cid=F3C9100733704C2999046FEDA48410B7-2D")); err != nil {
		return fmt.Error("Unable to run falconctl error")
	}
	return "restart", nil
}
func restartCrowdStrike(ctx context.Context) (string, error) {
	check.Progress(ctx, "Restarting CrowdStrike")
	// restart falcon-sensor
	if err := cmd.Run(ctx, "systemctl", cmd.WithArgs("restart", "falcon-sensor.service")); err != nil {
		return "reinstall", fmt.Errorf("Unable to restart %s: %v", "falcon-sensor.service", err)
		
	}
	return fmt.Sprintf("Successfully restarted CrowdStrike")
}

func unmaskCrowdStrike(ctx context.Context) result.Result {
	check.Progress(ctx, "Unmasking CrowdStrike")
	// unmask falcon-sensor and start it
	if err := cmd.Run(ctx, "systemctl", cmd.WithArgs("unmask", "falcon-sensor.service")); err != nil {
		return fmt.Error("unable to unmask falcon-sensor.service")
	}
	if err := cmd.Run(ctx, "systemctl", cmd.WithArgs("start", "falcon-sensor.service")); err != nil {
		return fmt.Errof("unable to restart falcon-sensor.service")
	}
	return fmt.Sprint("Successfully unmasked CrowdStrike")
}
